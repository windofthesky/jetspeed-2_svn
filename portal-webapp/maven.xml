<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project [
  <!ENTITY % locator-entities SYSTEM "file:locator.ent"> %locator-entities;
]>
<!--
    Copyright 2004 The Apache Software Foundation
    
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at
    
    http://www.apache.org/licenses/LICENSE-2.0
    
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<project default="java:jar" xmlns:j="jelly:core" xmlns:define="jelly:define" xmlns:maven="jelly:maven">

    <goal name="pam.layoutdeploy">
        <j:set var="maven.war.final.name" value="jetspeed-layouts" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.demodeploy">
        <j:set var="maven.war.final.name" value="demo" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.demoundeploy">
        <j:set var="maven.war.final.name" value="demo" />
        <attainGoal name="jetspeed2:undeploy" />
    </goal>

    <goal name="pam.palmdeploy">
        <j:set var="maven.war.final.name" value="palm" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.palmundeploy">
        <j:set var="maven.war.final.name" value="palm" />
        <attainGoal name="jetspeed2:undeploy" />
    </goal>

    <goal name="pam.pamdeploy">
        <j:set var="maven.war.final.name" value="pam" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.pamundeploy">
        <j:set var="maven.war.final.name" value="pam" />
        <attainGoal name="pam.template.undeploy" />
    </goal>

    <goal name="pam.tsdeploy">
        <j:set var="maven.war.final.name" value="testsuite" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.tsundeploy">
        <j:set var="maven.war.final.name" value="testsuite" />
        <attainGoal name="jetspeed2:undeploy" />
    </goal>

    <goal name="pam.strutsdeploy">
        <j:set var="maven.war.final.name" value="struts-demo" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.strutsundeploy">
        <j:set var="maven.war.final.name" value="struts-demo" />
        <attainGoal name="jetspeed2:undeploy" />
    </goal>

    <goal name="pam.jpetstoredeploy">
        <j:set var="maven.war.final.name" value="jpetstore" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.jpetstoreundeploy">
        <j:set var="maven.war.final.name" value="jpetstore" />
        <attainGoal name="pam.template.undeploy" />
    </goal>

    <goal name="pam.jsfdeploy">
        <j:set var="maven.war.final.name" value="jsf-demo" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.jsfundeploy">
        <j:set var="maven.war.final.name" value="jsf-demo" />
        <attainGoal name="jetspeed2:undeploy" />
    </goal>

    <goal name="pam.jsfmyfacesdeploy">
        <j:set var="maven.war.final.name" value="jsf-demo-myfaces" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.jsfmyfacesundeploy">
        <j:set var="maven.war.final.name" value="jsf-demo-myfaces" />
        <attainGoal name="jetspeed2:undeploy" />
    </goal>

    <goal name="pam.securitydeploy">
        <j:set var="maven.war.final.name" value="security" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.securityundeploy">
        <j:set var="maven.war.final.name" value="security" />
        <attainGoal name="jetspeed2:undeploy" />
    </goal>

    <goal name="pam.phpdeploy">
        <j:set var="maven.war.final.name" value="php" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.phpundeploy">
        <j:set var="maven.war.final.name" value="php" />
        <attainGoal name="jetspeed2:undeploy" />
    </goal>

    <goal name="pam.perldeploy">
        <j:set var="maven.war.final.name" value="perl" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.perlundeploy">
        <j:set var="maven.war.final.name" value="perl" />
        <attainGoal name="jetspeed2:undeploy" />
    </goal>

    <goal name="pam.rssdeploy">
        <j:set var="maven.war.final.name" value="rss" />
        <attainGoal name="jetspeed2:deploy" />
    </goal>

    <goal name="pam.rssundeploy">
        <j:set var="maven.war.final.name" value="rss" />
        <attainGoal name="jetspeed2:undeploy" />
    </goal>

    <!-- ================================================================ -->
    <!-- Deploy to Catalina and Expand                                    -->
    <!-- ================================================================ -->
    <goal name="deploy">
        <echo message="Deploying ${pom.id}, ${pom.name}" />
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/${org.apache.jetspeed.portal.name}" />
        <copy file="./target/${pom.artifactId}.war"
            tofile="${org.apache.jetspeed.deploy.war.dir}/${org.apache.jetspeed.portal.name}.war" />
        <unwar src="${org.apache.jetspeed.deploy.war.dir}/${org.apache.jetspeed.portal.name}.war"
            dest="${org.apache.jetspeed.deploy.war.dir}/${org.apache.jetspeed.portal.name}" />

        <j:set var="catalina_version_major" value="${org.apache.jetspeed.catalina.version.major}" />
        <j:choose>
            <j:when test="${catalina_version_major == '5.5'}">
                <j:set var="context_file_source" value="jetspeed-tomcat-5.5.xml" />
            </j:when>
            <j:otherwise>
                <j:set var="context_file_source" value="jetspeed-tomcat-5.xml" />
            </j:otherwise>
        </j:choose>
        <j:set var="context_file_target"
            value="${org.apache.jetspeed.server.home}/conf/Catalina/localhost/jetspeed.xml" />
        <copy file="./src/resources/${context_file_source}" tofile="${context_file_target}" overwrite="true">
            <filterset begintoken="@" endtoken="@">
                <filter token="USERNAME" value="${org.apache.jetspeed.production.database.user}" />
                <filter token="PASSWORD" value="${org.apache.jetspeed.production.database.password}" />
                <filter token="DRIVER" value="${org.apache.jetspeed.production.database.driver}" />
                <filter token="URL" value="${org.apache.jetspeed.production.database.url}" />
            </filterset>
        </copy>
        <attainGoal name="catalina:base-shared" />
        <attainGoal name="catalina:shared" />
    </goal>

    <!-- ================================================================ -->
    <!-- Hot Deploy for mundane everyday development under Catalina       -->
    <!-- ================================================================ -->
    <goal name="hotdeploy">
        <echo message="Hot Deploying ${pom.id}, ${pom.name} ${maven.war.src}" />
        <copy todir="${org.apache.jetspeed.deploy.war.dir}/${org.apache.jetspeed.portal.name}/WEB-INF/classes">
            <fileset dir="${maven.build.dir}/classes"></fileset>
        </copy>
        <copy todir="${org.apache.jetspeed.deploy.war.dir}/${org.apache.jetspeed.portal.name}/">
            <fileset dir="./src/webapp">
                <exclude name="WEB-INF/db/**" />
            </fileset>
        </copy>
    </goal>

    <preGoal name="hotdeploy">
        <attainGoal name="java:compile" />
    </preGoal>

    <!-- ================================================================ -->
    <!-- Does all three deployment steps at once                                                                        -->
    <!-- ================================================================ -->
    <goal name="fullDeploy">

        <attainGoal name="deploy" />
        <attainGoal name="pam.layoutdeploy" />
        <attainGoal name="pam.demodeploy" />
        <attainGoal name="pam.palmdeploy" />
        <attainGoal name="pam.pamdeploy" />
        <attainGoal name="pam.strutsdeploy" />
        <attainGoal name="pam.jsfdeploy" />
        <attainGoal name="pam.jsfmyfacesdeploy" />
        <attainGoal name="pam.securitydeploy" />
        <attainGoal name="pam.phpdeploy" />
        <attainGoal name="pam.perldeploy" />
        <attainGoal name="pam.rssdeploy" />
        <attainGoal name="pam.jpetstoredeploy" />

        <attainGoal name="db.entities" />
    </goal>

    <goal name="nodbfullDeploy">
        <attainGoal name="deploy" />
        <attainGoal name="pam.layoutdeploy" />
        <attainGoal name="pam.demodeploy" />
        <attainGoal name="pam.palmdeploy" />
        <attainGoal name="pam.pamdeploy" />
        <attainGoal name="pam.strutsdeploy" />
        <attainGoal name="pam.jsfdeploy" />
        <attainGoal name="pam.jsfmyfacesdeploy" />
        <attainGoal name="pam.securitydeploy" />
        <attainGoal name="pam.phpdeploy" />
        <attainGoal name="pam.perldeploy" />
        <attainGoal name="pam.rssdeploy" />
        <attainGoal name="pam.jpetstoredeploy" />
    </goal>

    <goal name='minDeploy'>
        <attainGoal name="deploy" />
        <attainGoal name="pam.layoutdeploy" />
        <attainGoal name="pam.securitydeploy" />
        <attainGoal name="db.entities" />
    </goal>

    <goal name='nodbMinDeploy'>
        <attainGoal name="remove.wars" />
        <attainGoal name="deploy" />
        <attainGoal name="pam.layoutdeploy" />
        <attainGoal name="pam.securitydeploy" />
    </goal>

    <goal name="catalina:base-shared" description="Copy all base jars necessary for common container">
        <echo>Copying from ${maven.repo.local} to ${org.apache.jetspeed.server.shared}...</echo>
        <copy file="${maven.repo.local}/pluto/jars/pluto-&pluto-version;.jar"
            todir="${org.apache.jetspeed.server.shared}" />
        <copy
            file="${maven.repo.local}/portals-bridges/jars/portals-bridges-common-&portals-bridges-common-version;.jar"
            todir="${org.apache.jetspeed.server.shared}" />
    </goal>

    <goal name="catalina:shared" description="Copy all jars necessary for common container">
        <copy file="../commons/target/jetspeed-commons-&jetspeed-version;.jar"
            todir="${org.apache.jetspeed.server.shared}" />
        <copy file="../jetspeed-api/target/jetspeed-api-&jetspeed-version;.jar"
            todir="${org.apache.jetspeed.server.shared}" />
        <copy file="../portlet-api/target/portlet-api-1.0.jar" todir="${org.apache.jetspeed.server.shared}" />
    </goal>

    <!-- ================================================================ -->
    <!-- Copy OJB mapping for registry into the portal directory-->
    <!-- ================================================================ -->
    <goal name="db.test.properties">
        <j:set var="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.test.database.url}" />
        <j:set var="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.test.database.driver}" />
        <j:set var="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.test.database.user}" />
        <j:set var="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.test.database.password}" />
        <j:set var="org.apache.jetspeed.jdbc.drivers.path" value="${org.apache.jetspeed.test.jdbc.drivers.path}" />
    </goal>

    <goal name="db.production.properties">
        <j:set var="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.production.database.url}" />
        <j:set var="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.production.database.driver}" />
        <j:set var="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.production.database.user}" />
        <j:set var="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.production.database.password}" />
        <j:set var="org.apache.jetspeed.jdbc.drivers.path" value="${org.apache.jetspeed.production.jdbc.drivers.path}" />
    </goal>

    <!-- ================================================================ -->
    <!-- EXECUTE a DB SCRIPT                                              -->
    <!-- ================================================================ -->
    <goal name="db.execute">
        <sql driver="${org.apache.jetspeed.database.driver}" classpathref="maven.dependency.classpath"
            url="${org.apache.jetspeed.database.url}" userid="${org.apache.jetspeed.database.user}"
            password="${org.apache.jetspeed.database.password}" src="${database.arg.script}">
            <classpath>
                <path refid="maven.dependency.classpath" />
                <pathelement path="${org.apache.jetspeed.jdbc.drivers.path}" />
            </classpath>
        </sql>
    </goal>

    <goal name="db.entities">
        <j:set var="dbase" value="${org.apache.jetspeed.production.database.default.name}" />
        <attainGoal name="db.production.properties" />
        <!--
            <j:choose>
            <j:when test="${dbase == 'mysql'}" >
            <j:set var="database.arg.script" value="../src/sql/mysql/populate-entities-for-default-psml.sql" />
            </j:when>
            <j:otherwise>
            <j:set var="database.arg.script" value="../src/sql/populate-entities-for-default-psml.sql" />
            </j:otherwise>
            </j:choose>
            
            <attainGoal name="db.execute" />
        -->
        <j:choose>
            <j:when test="${dbase == 'mssql'}">
                <j:set var="database.arg.script" value="../src/sql/mssql/populate-userinfo-for-default-psml.sql" />
            </j:when>
            <j:when test="${dbase == 'mysql'}">
                <j:set var="database.arg.script" value="../src/sql/mysql/populate-userinfo-for-default-psml.sql" />
            </j:when>
            <j:when test="${dbase == 'oracle'}">
                <j:set var="database.arg.script" value="../src/sql/oracle/populate-userinfo-for-default-psml.sql" />
            </j:when>
            <j:when test="${dbase == 'hsql'}">
                <j:set var="database.arg.script" value="../src/sql/hsql/populate-userinfo-for-default-psml.sql" />
            </j:when>
            <j:otherwise>
                <j:set var="database.arg.script" value="../src/sql/populate-userinfo-for-default-psml.sql" />
            </j:otherwise>
        </j:choose>
        <attainGoal name="db.execute" />
    </goal>

    <goal name="ojb.set.production.database.platform">
        <copy todir="${maven.build.dest}" overwrite="true">
            <fileset dir="../etc/db-ojb" />
            <filterset begintoken="@" endtoken="@">
                <filter token="PLATFORM" value="${org.apache.jetspeed.production.database.ojb.platform}" />
            </filterset>
        </copy>
    </goal>

    <preGoal name="war:init">
        <attainGoal name="jar:install" />
        <j:set var="maven.test.skip" value="true" />
        <echo>Testing flag is: ${maven.test.skip} for war:install</echo>
    </preGoal>

    <postGoal name="war:install">
        <j:set var="maven.test.skip" value="false" />
    </postGoal>

    <preGoal name="war:webapp">
        <attainGoal name="ojb.set.production.database.platform" />
    </preGoal>

    <postGoal name="war:webapp">
        <copy file="${maven.war.src}/WEB-INF/conf/jetspeed.properties"
            tofile="${maven.war.webapp.dir}/WEB-INF/conf/jetspeed.properties" overwrite="true">
            <filterset begintoken="@" endtoken="@">
                <filter token="AUTODEPLOYMENT_SERVER" value="${org.apache.jetspeed.services.autodeployment.server}" />
                <filter token="AUTODEPLOYMENT_USER" value="${org.apache.jetspeed.services.autodeployment.user}" />
                <filter token="AUTODEPLOYMENT_PASSWORD" value="${org.apache.jetspeed.services.autodeployment.password}" />
            </filterset>
            <!-- Below filter is special because this concerns a numeric property for which a non-numeric token results
                in a test failure (TestSpringEngine)
                This property therefore MUST remain defined EXACTLY as specified for this filter to be able to work
            -->
            <filterset begintoken="autodeployment.catalina.version.major" endtoken="5">
                <filter token="="
                    value="autodeployment.catalina.version.major=${org.apache.jetspeed.catalina.version.major}" />
            </filterset>
            <filterset begintoken="autodeployment.port" endtoken="8080">
                <filter token="=" value="autodeployment.port=${org.apache.jetspeed.services.autodeployment.port}" />
            </filterset>
        </copy>
    </postGoal>

    <goal name='remove.wars'>
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/${org.apache.jetspeed.portal.name}" />
        <delete file="${org.apache.jetspeed.deploy.war.dir}/${org.apache.jetspeed.portal.name}.war" />
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/demo" />
        <delete file="${org.apache.jetspeed.deploy.war.dir}/demo.war" />
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/palm" />
        <delete file="${org.apache.jetspeed.deploy.war.dir}/palm.war" />
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/pam" />
        <delete file="${org.apache.jetspeed.deploy.war.dir}/pam.war" />
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/security" />
        <delete file="${org.apache.jetspeed.deploy.war.dir}/security.war" />
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/struts-demo" />
        <delete file="${org.apache.jetspeed.deploy.war.dir}/struts-demo.war" />
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/jsf-demo" />
        <delete file="${org.apache.jetspeed.deploy.war.dir}/jsf-demo.war" />
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/jsf-demo-myfaces" />
        <delete file="${org.apache.jetspeed.deploy.war.dir}/jsf-demo-myfaces.war" />
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/php" />
        <delete file="${org.apache.jetspeed.deploy.war.dir}/php.war" />
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/perl" />
        <delete file="${org.apache.jetspeed.deploy.war.dir}/perl.war" />
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/rss" />
        <delete file="${org.apache.jetspeed.deploy.war.dir}/rss.war" />
        <delete dir="${org.apache.jetspeed.deploy.war.dir}/jpetstore" />
        <delete file="${org.apache.jetspeed.deploy.war.dir}/jpetstore.war" />
        <j:set var="context_dir" value="${org.apache.jetspeed.server.home}/conf/Catalina/localhost" />
        <delete file="${context_dir}/${org.apache.jetspeed.portal.name}.xml" />
        <delete file="${context_dir}/security.xml" />
        <delete file="${context_dir}/jpetstore.xml" />
    </goal>

</project>
