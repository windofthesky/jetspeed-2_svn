<?xml version="1.0"?>
<!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at
  
  http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<document>
  <properties>
    <title>Guide to using NTLM Authentication</title>
    <subtitle>How to configure NTLM authentication with an optional fallback authentication method.</subtitle>
    <authors>
      <person name="Dennis Dam" email="d.dam@hippo.nl" />
    </authors>
  </properties>
  <body>
    <section name="NTLM Authentication in Jetspeed">
      <p>
      NTLM Authentication can be used for Single Sign On (SSO) from a Windows client/browser. A nice explanation about NTLM can be found <a href="http://jcifs.samba.org/src/docs/ntlmhttpauth.html">here</a>.
        Jetspeed-2 supports NTLM Authentication based on the <a href="http://jcifs.samba.org">jCIFS</a> Servlet filter. With the approach described below
      you can use NTLM Authentication with an optional fallback to the default active authentication and as such this solution can be used as a drop-in replacement.
      A typical application for a fallback login method would be when users log on to an intranet from a different domain: these users can
      be redirected to a login screen.<br/>
      The solution below can also be used as a replacement for the default Security Valve: 
      if you don't configure the filters, then Jetspeed's default authorization will be applied.
      </p>      
    </section>
    <section name="Configuring NTLM Authentication">
      <p>
        Jetspeed-2 security configuration is explained  
        <a href="guide-security.html">
          here
        </a>
        .
      </p>
      <subsection name="Configuring NTLM servlet filters">
        <p>
          The first step is to configure jCIFS NTLM HTTP Authentication, which is explained <a href="http://jcifs.samba.org/">here</a>.
          You configure jCIFS as a filter in the web.xml of your webapp. Next, you must configure
          a second Jetspeed servlet filter, which must be placed right <i>after</i> the jCIFS filter. An example configuration:
        </p>
        <source><![CDATA[
<filter>
  <filter-name>NtlmHttpFilter</filter-name>
  <filter-class>jcifs.http.NtlmHttpFilter</filter-class>
  <init-param>
    <param-name>jcifs.smb.client.domain</param-name>
    <param-value>SOME_DOMAIN</param-value>
  </init-param>
</filter>

<filter>
  <filter-name>NtlmHttpServletRequestFilter</filter-name>
  <filter-class>org.apache.jetspeed.security.impl.ntlm.NtlmHttpServletRequestFilter</filter-class>
  <init-param>
    <param-name>org.apache.jetspeed.security.ntlm.ignoreUrls</param-name>
    <param-value>/login/login</param-value>
  </init-param>
</filter>

<filter-mapping>
  <filter-name>NtlmHttpFilter</filter-name>
  <url-pattern>/*</url-pattern>
</filter-mapping>

<filter-mapping>
  <filter-name>NtlmHttpServletRequestFilter</filter-name>
  <url-pattern>/*</url-pattern>
</filter-mapping>]]></source>
      </subsection>
      <subsection name="Configuring NTLM Security Valve">
        <p>
          The above filters set the correct credentials on the request. To use these credentials, you
          have to configure the <code>org.apache.jetspeed.security.impl.ntlm.NtlmSecurityValve</code> in the
          Jetspeed pipelines you want to secure. This Valve can be used as a <i>replacement</i> for the default <code>SecurityValveImpl</code>. For explanation about how to set up pipelines, see
          <a href="guide-pipeline.html">here</a>. An example of how to configure the NtlmSecurityValve bean:          
        </p>
        <source>
        <![CDATA[
<bean id="securityValve" class="org.apache.jetspeed.security.impl.ntlm.NtlmSecurityValve" init-method="initialize">
  <constructor-arg>
    <ref bean="org.apache.jetspeed.security.UserManager" />
  </constructor-arg>
  <!-- Network domain. This value is optionally stripped from the authenticated user name -->
  <constructor-arg><value>SOME_DOMAIN</value></constructor-arg>
  <!-- Omit domain in user principal -->
  <constructor-arg><value>true</value></constructor-arg>
  <!-- 
     NTLM Authorization required. 
     If set to true, only users authenticated by NTLM authentication will be authorized. 
  -->
  <constructor-arg><value>false</value></constructor-arg>
</bean>]]></source>        
      </subsection>
    </section>
  </body>
</document>