<?xml version="1.0"?>
<!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at
  
  http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<document>
    <properties>
        <title>Jetspeed 2 Security - Credentials Management</title>
        <authors>
            <person name="David Le Strat" email="dlestrat@apache.org" />
            <person name="Ate Douma" email="ate@douma.nu" />
        </authors>
    </properties>
    <body>
        <section name="User interaction">
            <p>
            Although the <code>DefaultCredentialHandler</code> provides fine-grained management of credentials, it cannot
            provide direct feedback to the user like presenting a warning that the current password is soon to be expired.
            But, special request processing pipeline valves provided with jetspeed allow to do just that.</p>
            <p>
            The configuration for these valves can be found and set in the <code>pipelines.xml</code> spring
            configuration file.</p>
            <subsection name="LoginValidationValveImpl">
              <p>
              The <a href="apidocs/org/apache/jetspeed/security/impl/LoginValidationValveImpl.html">
              <code>LoginValidationValveImpl</code></a> provides feedback to the user about the cause of an failed login
              attempt.</p>
              <p>
              It retrieves the <code>UserPrincipal</code> and its current <code>PasswordCredential</code> for the 
              specified user name, and (if found) determines an specific error code based on its state. 
              This error code is communicated back to through the session so an appropriate error message can be
              presented to the user.</p>
              <p>
              The following possible error codes can be returned (all defined in the
              <a href="jetspeed-api/apidocs/org/apache/jetspeed/login/LoginConstants.html">
              <code>LoginConstants</code></a> interface):</p>
              <ol>
                <li>ERROR_UNKNOWN_USER</li>
                <li>ERROR_INVALID_PASSWORD</li>
                <li>ERROR_USER_DISABLED</li>
                <li>ERROR_FINAL_LOGIN_ATTEMPT</li>
                <li>ERROR_CREDENTIAL_DISABLED</li>
                <li>ERROR_CREDENTIAL_EXPIRED</li>
              </ol>
              <p>
              Of the above error codes, the <code>ERROR_FINAL_LOGIN_ATTEMPT</code> will only be reported if the valve
              is configured with the same <code>maxNumberOfAuthenticationFailures</code> value as used for the
              related <code>MaxPasswordAuthenticationFailuresInterceptor</code> described above:
              <source><![CDATA[
  <bean id="loginValidationValve"
        class="org.apache.jetspeed.security.impl.LoginValidationValveImpl"
        init-method="initialize">
    <!-- maxNumberOfAuthenticationFailures
         This value should be in sync with the value for
         org.apache.jetspeed.security.spi.impl.MaxPasswordAuthenticationFailuresInterceptor
         (if used) to make sense.
         Any value < 2 will suppress the LoginConststants.ERROR_FINAL_LOGIN_ATTEMPT
         error code when only one last attempt is possible before the credential
         will be disabled after the next authentication failure.
    -->
    <constructor-arg index="0"><value>3</value></constructor-arg>  
</bean>]]>
                </source>
              </p>
            </subsection>
            <subsection name="PasswordCredentialValveImpl">
              <p>
              The <a href="jetspeed-portal/apidocs/org/apache/jetspeed/security/impl/PasswordCredentialValveImpl.html">
              <code>PasswordCredentialValveImpl</code></a> is meant to be used together with a special Portlet on a
              special Portal Page (PSML) to automatically request or even require a user to change its password.</p>
              <p>
              This valve evaluates <code>PasswordCredential.isUpdateRequired()</code> and optionally the 
              <code>expirationDate</code>, <code>lastAuthenticationDate</code> and <code>previousAuthenticationDate</code>
              fields to determine if a user is required or just be asked to change its password.</p>
              <p>
              This valve can optionally be configured with a list of  <code>expirationWarningDays</code> numbers in
              its constructor:
              <source><![CDATA[
<bean id="passwordCredentialValve"
      class="org.apache.jetspeed.security.impl.PasswordCredentialValveImpl"
      init-method="initialize">
 <constructor-arg>
   <!-- expirationWarningDays -->
   <list>
     <value>2</value>
     <value>3</value>
     <value>7</value>
   </list>
 </constructor-arg>
</bean>]]>
                </source>
              These numbers each represent a day before the current <code>expirationDate</code> of the password credential
              when a user should be warned its password is soon to expire and be asked to change it. The
              <code>lastAuthenticationDate</code> and the <code>previousAuthenticationDate</code> are used to determine
              when this should happen. It will be done only once for each configured <code>expirationWarningDay</code>.
              If a user logs on for the first time (after several days) with the above example configuration, 6 days
              before the password expires, he or she will be warned about it. And again when 3 or 2 days are left.</p>
              <p>
              When a user logs on the last day before the password expires <em>or</em> when <code>updateRequired</code>
              is <code>true</code>, the user will be required to change the password, regardless if expirationWarningDays
              are configured or not.</p>
              <p>
              To be able to automatically provide the user with this information and allow or require the password to
              be changed directly after login, a special <code>ProfileLocator</code> 
              <a href="jetspeed-api/apidocs/org/apache/jetspeed/profiler/ProfileLocator.html#SECURITY_LOCATOR">
              <code>SECURITY_LOCATOR</code></a> is used. The <code>PageProfilerValve</code> (which should be configed
              <em>after</em> this valve in the pipeline) will then use this enforced locator to be used to find the
              related portal page to present to the user.</p>
              <p>
              For this to work, a <code>"security"</code> Profiler rule must have been setup like the default one 
              provided by Jetspeed:</p>
              <p align="center">
                <img src="deployguide/images/security-locator.jpg" border="0"/>
              </p>
              <p>
              As can seen from the above image, the default page which will be presented to the user is the
              <code>/my-account.psml</code> located in the root.</p>
              <p>
              This default page contains only one portlet, the <code>ChangePasswordPortlet</code> from the security
              Portlet Application.</p>
              <p>
              The <code>ChangePasswordPortlet</code> works together with the <code>PasswordCredentialValveImpl</code>
              as it checks for the 
              <a href="jetspeed-api/apidocs/org/apache/jetspeed/security/PasswordCredential.html#PASSWORD_CREDENTIAL_DAYS_VALID_REQUEST_ATTR_KEY">
              <code>PASSWORD_CREDENTIAL_DAYS_VALID_REQUEST_ATTR_KEY</code></a> request parameter which will be set by
              this valve with the number of days the password is still valid. For a required password change this will
              be set to Integer(0).</p>
              <p>
              The default <code>my-account.psml</code> page contains <em>only</em> the <code>ChangePasswordPortlet</code>
              to make sure a user which is <em>required</em> to change the password cannot interact with the portal any
              other way then after the password is changed.</p>
              <p>
              Although the user might be attempted to select a link to a different page (from a portal menu for exampl),
              this valve will make sure only the configured "security" locator page is returned if it is required.
              But, once the password is changed the then targeted page in the url will be navigated to automatically.
              </p>
            </subsection>
        </section>
    </body>
</document>
