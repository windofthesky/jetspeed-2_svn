<?xml version="1.0"?>
<!--
Licensed to the Apache Software Foundation (ASF) under one or more
contributor license agreements.  See the NOTICE file distributed with
this work for additional information regarding copyright ownership.
The ASF licenses this file to You under the Apache License, Version 2.0
(the "License"); you may not use this file except in compliance with
the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<document>
  <properties>
    <title>Profiler Configuration</title>
    <subtitle>Profiler Configuration</subtitle>
    <authors>
      <person name="David Sean Taylor" email="taylor@apache.org"/>
    </authors>
  </properties>
  <body>
  
<section name="Profiler">

	<p>
		The Jetspeed Profiler is a portal resource location rule-based
		engine. The profiler locates the following kinds of portal
		resources:
		<ul>
			<li>PSML pages</li>
			<li>Folders</li>
			<li>Menus</li>
		</ul>
	</p>
	
	<p>
		When a request is received by the portal, the profiler will map the
		request to a resource based on a normalized set of runtime
		parameters and state such as request parameters, HTTP headers,
		and session attributes. The Profiler is invoked during the Jetspeed
		request processing pipeline in the profiler valve. This valve
		requires that the request context is already populated with the
		portal request and response, capabilities, language and user
		information. The runtime parameters make up the profile criterion
		which the profiler uses to locate portal resources. The profiler
		works hand in hand with the Site and Page Manager components.
	</p>
	
	<subsection name="Profiler Rules and Rule Criteria">
		<p>
			A Profiling Rule defines a list of criteria used when evaluating a
			request to determine the location of a specific resource. Profiling
			rules are used by the profiler to generically locate portal resources
			based on the decoupled criteria for known portlet request data. A
			rule consists of an ordered list of criteria which should be applied in
			a given order. Following this rule's order, the profiling engine applies
			each criteria of the rules using a less-specific algorithm until the
			least specific resource criterion is considered. When all criteria are
			exhausted, the rule will fail and a fallback resource will be required.		
		</p>
		<p>
			Rule Criteria are templates for locating profile properties. Jetspeed has
			a profiling policy based on resource-specific URLs, Mime-Types and
			language preferences. More complex implementations will need to
			use other inputs in mapping to resources such as Cookies, IP
			Address Ranges, Statistical Resource Usage Analysis, Business
			Rules inside of servlets or EJBs,...		
		</p>
	</subsection>	
	
	<subsection name="Resolvers">				
		<p>	
			Resolvers are Java classes that try to match criteria to find resources.  Jetspeed provides several resolvers 'out of the box'.
		</p>
		<p>
			<table>
				<tr>
			        <td>request</td>    
			        <td>match request parameter</td>
			    </tr>
				<tr>
			        <td>session</td>    
			        <td>match session parameter</td>
			    </tr>
				<tr>
			        <td>path</td>    
			        <td>match the path portion of the URL to the PSML page</td>
			    </tr>
				<tr>
			        <td>hard.coded</td>    
			        <td>a hard-coded value, such as “default-page.psml” </td>
			    </tr>
				<tr>
			        <td>user</td>    
			        <td>match the name of the current authenticated user</td>
			    </tr>
				<tr>
			        <td>mediatype</td>    
			        <td>match the mediatype (HTML,XHTML..) </td>
			    </tr>
				<tr>
			        <td>language</td>    
			        <td>the browser’s preferred language</td>
			    </tr>
				<tr>
			        <td>country</td>    
			        <td>the browsers preferred country code</td>
			    </tr>
				<tr>
			        <td>user.attribute</td>    
			        <td>match a named user attribute (Portlet API) </td>
			    </tr>
				<tr>
			        <td>user.agent</td>    
			        <td>the name of the agent (browser) </td>
			    </tr>
				<tr>
			        <td>hostname</td>    
			        <td>match the hostname in the URL</td>
			    </tr>
				<tr>
			        <td>navigation</td>    
			        <td>directive: move algorithm to start search in new location</td>
			    </tr>
				<tr>
			        <td>group.role.user</td>    
			        <td>use fallback algorithm</td>
			    </tr>
			    			        
			</table>
		</p>			
	</subsection>	
	
	<subsection name="PSML Pages">
		<p>
			The Profiler searches over a directory tree of
			PSML pages trying to locate a PSML page to
			be displayed. By default, this directory
			structure is found under <strong><code>/WEB-INF/pages</code></strong>. The
			‘directory’ can also be stored in the database.
			There are several system directories known by
			the profiler:
		</p>
		<p>
			<table>
			    <tr>
			        <td>_user</td>    
			        <td>Holds all user-specific pages.</td>
			    </tr>
			    <tr>
			        <td>_role</td>    
			        <td>Holds all role-specific pages.</td>
			    </tr>
			    <tr>
			        <td>_group</td>    
			        <td>Holds all group-specific pages.</td>>
			    </tr>
			    <tr>
			        <td>_subsite-root</td>    
			        <td>Contains complete subsite trees, exactly like root tree.</td>
			    </tr>			    			        
			</table>
		</p>
       		<p>
				<img src="images/psml-pages.jpg" border="0"/><br/><br/>
			</p>			
	</subsection>

	<subsection name="Common Profiler Rules Provided">
		<p>
			<table>
			    <tr>
			        <td>J1</td>    
			        <td>Uses a most-specific to least-specific algorithm from Jetspeed-1 (Page-Path + User + Media Type + Language + Country)</td>
			    </tr>
			    <tr>
			        <td>J2</td>    
			        <td>Default. Looks at the URL path combined with User + Media. (Page-Path + User + Media Type)</td>
			    </tr>
			    <tr>
			        <td>Role Fallback</td>    
			        <td>Look for page in each role dir for the given user.</td>>
			    </tr>
			    <tr>
			        <td>User-Role Fallback</td>    
			        <td>Look for page in user’s home dir, if not found, look in each role dir for the given user.</td>
			    </tr>
			    <tr>
			        <td>Variants</td>    
			        <td>Path, Group Fallback, User-Role-Combo Fallback, Subsite-Roll Fallback.</td>
			    </tr>			    			        
			</table>        
		</p>
	</subsection>
	
	<subsection name="Profiler Component Configuration">
		<p>
			The profiler.xml Spring configuration file configures the profiler component.
			<table>
			    <tr>
			        <th>Constructor Argument</th>
			        <th>Description</th>
			    </tr>
			    <tr>
			        <td>(0) JETSPEED-INF/ojb/profiler_repository.xml</td>    
			        <td>Holds the OJB database to POJO mapper for marshalling profile information to and from the persistent store.</td>
			    </tr>
			    <tr>
			        <td>(1) j1</td>    
			        <td>The default profiling rule. If a user does not have a profiling rule defined in the association table, this profiling rule is used.</td>
			    </tr>
			    <tr>
			        <td>(2) ProfileResolvers (ref bean)</td>    
			        <td>The map of profiler resolver names to implementing resolver classes. New resolvers should be added to the ProfileResolver table.</td>
			    </tr>    
			</table>        
		</p>
	</subsection>
</section>
</body>
</document>
