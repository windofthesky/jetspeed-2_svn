<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright 2004 The Apache Software Foundation
    
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at
    
    http://www.apache.org/licenses/LICENSE-2.0
    
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<project default="java:jar" xmlns:j="jelly:core" xmlns:maven="jelly:maven" xmlns:ant="jelly:ant">

    <goal name="_findProjectFile">
        <j:set var="_projectFileFound" value="false" />
        <j:set var="_projectFile" value="" />
        <j:set var="myPom" value="${pom}" />
        <j:while test="${myPom!=null}">
            <j:set var="pomDir" value="${myPom.file.parent}" />
            <j:new var="file" className="java.io.File">
                <j:arg value="${pomDir}/${_findProjectFile}" />
            </j:new>
            <j:if test="${file.exists()}">
                <j:set var="_projectFile" value="${file}" />
                <j:set var="_projectFileFound" value="true" />
                <j:break />
            </j:if>
            <j:set var="myPom" value="${myPom.parent}" />
        </j:while>
    </goal>

    <goal name="set.checkstyle.properties">

        <j:set var="_findProjectFile" value="${org.apache.jetspeed.checkstyle.header.file}" />
        <attainGoal name="_findProjectFile" />
        <j:if test="${!_projectFileFound}">
            <fail
                message="org.apache.jetspeed.checkstyle.header.file ${org.apache.jetspeed.checkstyle.header.file} not found in the project tree" />
        </j:if>
        <j:set var="maven.checkstyle.header.file" value="${_projectFile.absolutePath}" />
        <echo message="using maven.checkstyle.header.file ${maven.checkstyle.header.file}" />

        <j:set var="_findProjectFile" value="${org.apache.jetspeed.checkstyle.properties}" />
        <attainGoal name="_findProjectFile" />
        <j:if test="${!_projectFileFound}">
            <fail
                message="org.apache.jetspeed.checkstyle.properties ${org.apache.jetspeed.checkstyle.properties} not found in the project tree" />
        </j:if>
        <j:set var="maven.checkstyle.properties" value="${_projectFile.absolutePath}" />
        <echo message="using maven.checkstyle.properties ${maven.checkstyle.properties}" />
    </goal>

    <goal name="set.license.properties">

        <j:set var="_findProjectFile" value="${org.apache.jetspeed.license.licenseFile}" />
        <attainGoal name="_findProjectFile" />
        <j:if test="${!_projectFileFound}">
            <fail
                message="org.apache.jetspeed.license.licenseFile ${org.apache.jetspeed.license.licenseFile} not found in the project tree" />
        </j:if>
        <j:set var="maven.license.licenseFile" value="${_projectFile.absolutePath}" />
        <echo message="using maven.license.licenseFile ${maven.license.licenseFile}" />

    </goal>

    <preGoal name="checkstyle:init">
        <attainGoal name="set.checkstyle.properties" />
        <attainGoal name="set.license.properties" />
    </preGoal>

    <goal name="allClean" description="Clean the master project and all subprojects">
        <attainGoal name="subClean" />
        <attainGoal name="clean" />
    </goal>

    <goal name="allTest" description="Test all components">
        <j:set var="maven.test.skip" value="false" scope="parent" />
        <maven:reactor basedir="${basedir}" includes="components/*/project.xml"
            excludes="applications/project.xml" goals="test" banner="Testing..." ignoreFailures="false" />
    </goal>

    <goal name="subClean" description="Clean all subprojects">

        <maven:reactor basedir="${basedir}"
            includes="*/project.xml,applications/*/project.xml,services/*/project.xml,components/*/project.xml"
            excludes="applications/project.xml,taglibs/project.xml,portals-bridges/project.xml" goals="clean"
            banner="Cleaning" ignoreFailures="true" />
        <maven:reactor basedir="${basedir}"
            includes="layout-portlets/project.xml,maven-plugin/project.xml,taglibs/project.xml" goals="clean"
            banner="Cleaning" ignoreFailures="true" />
    </goal>

    <goal name="allSite"
          description="Build the site for the master project and all subprojects">

      <!-- Modified version of multiproject:site goal not using the reactor to run the site goal for each subproject
           but exec it in a separate process.
           This way one doesn't need to allocated 900M+ JVM memory to get this working!
      -->
      <maven:reactor
        basedir="${basedir}"
        banner="Gathering project list"
        includes="${maven.multiproject.includes}"
        excludes="${maven.multiproject.excludes}"
        postProcessing="true"
        collectOnly="true"
        collectionVar="multiprojects"
        ignoreFailures="${maven.multiproject.ignoreFailures}"
      />
      
      <j:set var="online" value="${maven.mode.online}"/>
      <j:choose>
        <j:when test="${online}">
          <j:set var="cmdargs" value="${maven.multiproject.site.goals}"/>
        </j:when>
        <j:otherwise>
          <j:set var="cmdargs" value="-o ${maven.multiproject.site.goals}"/>
        </j:otherwise>
      </j:choose>
        
      <j:forEach var="reactorProject" items="${multiprojects}">

        <!-- I don't know yet if this will work on Linux too ... -->
        <exec dir="${reactorProject.context.getVariable('basedir')}" vmlauncher="false" failonerror="true" executable="maven">
          <arg line="${cmdargs}"/>
        </exec>
      </j:forEach>        
      <echo>Now building reactor projects: ${multiprojects}</echo>
    
      <!-- copy each project over into ${maven.docs.dest} -->
      
      <j:forEach var="reactorProject" items="${multiprojects}">
        <j:set var="directory" value="${maven.docs.dest}/${maven.multiproject.aggregateDir}${reactorProject.artifactId}"/>
        <mkdir dir="${directory}"/>
        <j:set var="fromDir" value="${reactorProject.context.getVariable('maven.docs.dest')}"/>
        <mkdir dir="${fromDir}"/>
        <copy toDir="${directory}">
          <fileset dir="${fromDir}"/>
        </copy>
      </j:forEach>

      <attainGoal name="multiproject:create-nav"/>
      <attainGoal name="multiproject:create-overview-page"/>
      <attainGoal name="site" />
      <attainGoal name="pdf" />            
            
    </goal>
    
    <goal name="jetspeed2:jar:install">
        <maven:reactor basedir="${basedir}" includes="${jar.includes}" excludes="${jar.excludes}" goals="jar:install"
            banner="Build and Install all Jetspeed 2 jars" postProcessing="false" ignoreFailures="false" />
    </goal>

    <goal name="jetspeed2:war:install">
        <maven:reactor basedir="${basedir}"
            includes="applications/**/project.xml,layout-portlets/project.xml"
            excludes="applications/project.xml" goals="war:install" banner="Build and Install all Jetspeed 2 wars"
            postProcessing="false" ignoreFailures="false" />
    </goal>

    <goal name="initMavenPlugin">
    	<!-- build jetspeed 2 plugin core -->
		<maven:reactor basedir="${basedir}/maven-plugin" includes="project.xml" goals="deploy-plugin"
            banner="Build and deploy the Jetspeed 2 Maven plugin" postProcessing="false" ignoreFailures="false" />
    </goal>
    
    <goal name="allBuild" description="Build all jars and war">
            
        <attainGoal name="j2:check.required.properties" />
        <attainGoal name="j2:db.scripts.gen" />
        <j:if test="${context.getVariable('maven.test.skip') != 'true'}">
            <attainGoal name="j2:db.create.test" />
        </j:if>

        <!-- Build jars files-->
        <attainGoal name="jetspeed2:jar:install" />

        <!-- Build war files -->
        <attainGoal name="jetspeed2:war:install" />
        
        <maven:reactor basedir="${basedir}/portal-webapp" includes="project.xml" goals="j2:portal.install"
            banner="Build and deploy the Jetspeed 2 Portal Engine" postProcessing="false" ignoreFailures="false" />

        <!-- build jetspeed 2 plugin with webapp -->
        <maven:reactor basedir="${basedir}/maven-plugin" includes="project.xml" goals="deploy-plugin"
            banner="Build and deploy the Jetspeed 2 Maven plugin" postProcessing="false" ignoreFailures="false" />
    </goal>

    <goal name="show.maven.props">
        <echo message="maven.home.local = ${maven.home.local}" />
        <echo message="maven.repo.local = ${maven.repo.local}" />
    </goal>

	<!-- ================================================ -->
	<!-- ============== UNIT TESTS SUPPORT ============== -->
	<!-- ================================================ -->
    <!-- This will be inherited into all sub-projects to assists in
         setting jdbc test connecitons -->
    <!-- ================================================ -->
    
    <preGoal name="test:test">
        <attainGoal name="dbSetup" />
    </preGoal>

    <preGoal name="test:single">
        <attainGoal name="dbSetup" />
    </preGoal>

    <goal name="dbSetup">
        <j:set var="maven.junit.sysproperties"
            value="${maven.junit.sysproperties} org.apache.jetspeed.database.url org.apache.jetspeed.database.driver org.apache.jetspeed.database.user org.apache.jetspeed.database.password p6.home" />
        <j:set var="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.test.database.url}" />
        <j:set var="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.test.database.driver}" />
        <j:set var="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.test.database.user}" />
        <j:set var="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.test.database.password}" />

        <!-- make sure OJB platform property is translated/filtered: 
             @PLATFORM@ -> org.apache.jetspeed.test.database.ojb.platform
        -->
        <available property="_found" file="${maven.test.dest}/repository_database.xml" />
        <j:if test="${_found}">
          <tempfile destdir="${maven.test.dest}" prefix="tmp" suffix=".xml" property="temp.file"/>
          <copy file="${maven.test.dest}/repository_database.xml" tofile="${temp.file}" overwrite="true" failonerror="true">
            <filterset begintoken="@" endtoken="@">
              <filter token="PLATFORM" value="${org.apache.jetspeed.test.database.ojb.platform}" />
            </filterset>
          </copy>
          <copy file="${temp.file}" tofile="${maven.test.dest}/repository_database.xml" overwrite="true" failonerror="true"/>
          <delete file="${temp.file}"/>
        </j:if>

        <path id="jdbc.drivers.path" path="${org.apache.jetspeed.test.jdbc.drivers.path}" />
        <maven:addPath id="maven.dependency.classpath" refid="jdbc.drivers.path" />
    </goal>

</project>
