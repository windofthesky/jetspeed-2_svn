<project default="java:jar"
         xmlns:j="jelly:core" 
         xmlns:define="jelly:define"
         xmlns:reactor="reactor">

  <!-- Target of maven test:single test -->
  <property name='testcase' value='org.apache.jetspeed.components.TestComponentManager'/> 
  
   <goal name="deployJar">
  	<attainGoal name="jar:install"/>

  	<copy file="${basedir}/target/${maven.final.name}.jar" todir="${deploy.war.dir}/jetspeed/WEB-INF/lib"/>
  </goal>
  
   <!-- ================================================================ -->
  <!-- Merge OJB desriptor with Jetspeed main OJB descriptor                                              -->
  <!-- ================================================================ -->
  <goal name="ojb.registry">
    <copy  file="${basedir}/src/java/repository_registry.xml" tofile="${basedir}/../../portal/target/classes/repository_registry.xml"/>
    <copy  file="${basedir}/src/java/repository_registry.xml" tofile="${basedir}/../../portal/target/test-classes/repository_registry.xml"/>
   </goal>


  <!-- ================================================================ -->
  <!-- EXECUTE a DB SCRIPT                                              -->
  <!-- TODO: I'd like to implement this as a plugin or use commons SQL  -->
  <!-- ================================================================ -->
  <goal name="db.execute">
    <sql driver="${database.default.driver}"
         classpathref="maven.dependency.classpath"
         url="${database.default.url}"
         userid="${database.default.username}"
         password="${database.default.password}"
         src="${database.arg.script}">
    </sql>
  </goal>

  <!-- ================================================================ -->
  <!-- EXECUTE CREATE DB SQL SCRIPTS                                    -->
  <!-- TODO: I'd like to implement this as a plugin or use commons SQL  -->
  <!-- ================================================================ -->
  <goal name="db.create">
    <j:set var="database.arg.script" value="${basedir}/src/sql/${database.default.name}/create-db.sql" />
    <attainGoal name="db.execute" />
    <j:set var="database.arg.script" value="${basedir}/../../portal/src/sql/${database.default.name}/create-db-phase3-ojb.sql" />
    <attainGoal name="db.execute" />
  </goal>

  <!-- ================================================================ -->
  <!-- EXECUTE DROP DB SQL SCRIPTS                                      -->
  <!-- TODO: I'd like to implement this as a plugin or use commons SQL  -->
  <!-- ================================================================ -->
  <goal name="db.drop">
    <j:set var="database.arg.script" value="${basedir}/src/sql/${database.default.name}/drop-db.sql" />
    <attainGoal name="db.execute" />
    <j:set var="database.arg.script" value="${basedir}/../../portal/src/sql/${database.default.name}/drop-db.sql" />
    <attainGoal name="db.execute" />
  </goal>

  <!-- ================================================================ -->
  <!-- EXECUTE RECREATE DB SQL SCRIPTS                                  -->
  <!-- TODO: I'd like to implement this as a plugin or use commons SQL  -->
  <!-- ================================================================ -->
  <goal name="db.recreate">
    <attainGoal name="db.drop" />
    <attainGoal name="db.create" />
  </goal>

  <!-- ================================================================ -->
  <!-- TEST DB SQL SCRIPTS                                              -->
  <!-- ================================================================ -->
  <goal name="db.test.create">
    <j:set var="database.default.url" value="jdbc:hsqldb:${basedir}/../../portal/test/db/hsql/Registry" />
    <attainGoal name="db.create" />
  </goal>
  
  <goal name="db.test.create.server">
    <j:set var="database.default.url" value="jdbc:hsqldb:hsql://127.0.0.1:9001" />
    <attainGoal name="db.create" />
  </goal>

  <goal name="db.test.drop">
    <j:set var="database.default.url" value="jdbc:hsqldb:${basedir}/../../portal/test/db/hsql/Registry" />
    <attainGoal name="db.drop" />
  </goal>
  
  <goal name="db.test.drop.server">
    <j:set var="database.default.url" value="jdbc:hsqldb:hsql://127.0.0.1:9001" />
    <attainGoal name="db.drop" />
  </goal>

  <goal name="db.test.recreate">
    <attainGoal name="db.test.drop" />
    <attainGoal name="db.test.create" />
  </goal>
  
  <goal name="db.test.recreate.server">
    <attainGoal name="db.test.drop.server" />
    <attainGoal name="db.test.create.server" />
  </goal>
  
   <goal name="deployJar">
  	<attainGoal name="jar:install"/>

  	<copy file="${basedir}/target/${maven.final.name}.jar" todir="${deploy.war.dir}/jetspeed/WEB-INF/lib"/>
  </goal>
  
  <goal name="build.registry">
  	<attainGoal name="db.recreate"/>
  	<attainGoal name="db.test.recreate"/>
  	<attainGoal name="ojb.registry"/>
  	<attainGoal name="jar:install"/>
 </goal>
 
   <goal name="build.registry.server">
  	<attainGoal name="db.recreate"/>
  	<attainGoal name="db.test.recreate.server"/>
  	<attainGoal name="ojb.registry"/>
  	<attainGoal name="jar:install"/>
 </goal>
 

</project>
