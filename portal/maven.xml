<!--
Copyright 2004 The Apache Software Foundation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<project default="java:jar"
         xmlns:j="jelly:core"
         xmlns:define="jelly:define"
         xmlns:reactor="reactor"
         xmlns:maven="jelly:maven">

  <!-- Target of maven test:single test -->
<property name='testcase' value='org.apache.jetspeed.container.session.TestNavigationalState'/> 

<preGoal name="java:prepare-filesystem">
 	<echo message="====================================" />
  	<echo message="        Copying OJB Metadata        " />  	
  	<echo message="====================================" />
 	<maven:reactor
               basedir="${basedir}"
               includes="services/security/project.xml,components/registry/project.xml"
               goals="ojb.registry"
               banner="Copying OJB Metadata for Registry and Security"
               ignoreFailures="false"/>
 </preGoal>
 
 <!-- Always rbuild the DB befure we test 
 <preGoal name="test:test">
 	<attainGoal name="db.recreate" />
 </preGoal>
-->
 
<!--
  <goal name="jaxb:portlet"
        description="Generate java classes from protlet API schema">

      <echo>Processing "Compile portlet.xsd to java classes"</echo>

      <uptodate property="xsdBuild.uptodate"
        targetfile="./src/java/org/apache/jetspeed/om/portlets/PortletApp.java">
        <srcfiles dir= "../src/xml" includes="portlets.xsd"/>
      </uptodate>

     <j:set var="xsdBuild.notRequired" value="${xsdBuild.uptodate}"/>
    <echo>xsd=[${xsdBuild.notRequired}]</echo>

     <j:if test="${xsdBuild.notRequired == null}">
      <exec  executable="java" >
        <arg line="-jar ${maven.home}/repository/jaxb/jars/jaxb-xjc.jar -d ${basedir}/src -p java.org.apache.jetspeed.om.portlets ${basedir}/../src/xml/portlet.xsd"/>
      </exec>
    </j:if>
  </goal>

  <preGoal name="java:compile">
   <attainGoal name= "jaxb:portlet"/>
  </preGoal>
-->

 <goal name="pam.register">
         <java classname="org.apache.jetspeed.tools.pamanager.PortletApplicationManager" fork="yes">
          <classpath>
            <path refid="maven.dependency.classpath"/>
            <pathelement path="${maven.build.dest}"/>
          </classpath>
            <sysproperty key="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.database.url}"/>
            <sysproperty key="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.database.driver}"/>
            <sysproperty key="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.database.user}"/>
            <sysproperty key="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.database.password}"/>
            <arg value="-action" />
            <arg value="register" />
            <arg value="-PortletAppName" />
            <arg value="jetspeed" />
            <arg value="-warfilename" />
            <arg value="target/jetspeed.war" />
            <arg value="-webappDir" />
            <arg value="${pam.deploy.dir}/" />
            <arg value="-PortalName" />
            <arg value="jetspeed" />
        </java>
 </goal>

 <goal name="pam.unregister">
         <java classname="org.apache.jetspeed.tools.pamanager.PortletApplicationManager" fork="yes">
          <classpath>
            <path refid="maven.dependency.classpath"/>
            <pathelement path="${maven.build.dest}"/>
          </classpath>
            <sysproperty key="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.database.url}"/>
            <sysproperty key="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.database.driver}"/>
            <sysproperty key="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.database.user}"/>
            <sysproperty key="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.database.password}"/>
            <arg value="-action" />
            <arg value="unregister" />
            <arg value="-PortletAppName" />
            <arg value="jetspeed" />
            <arg value="-warfilename" />
            <arg value="target/jetspeed.war" />
            <arg value="-webappDir" />
            <arg value="${pam.deploy.dir}/" />
            <arg value="-PortalName" />
            <arg value="jetspeed" />
        </java>
 </goal>

 <goal name="pam.deploy">
         <java classname="org.apache.jetspeed.tools.pamanager.PortletApplicationManager" fork="yes">
          <classpath>
            <path refid="maven.dependency.classpath"/>
            <pathelement path="${maven.build.dest}"/>
          </classpath>
            <sysproperty key="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.database.url}"/>
            <sysproperty key="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.database.driver}"/>
            <sysproperty key="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.database.user}"/>
            <sysproperty key="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.database.password}"/>
            <arg value="-action" />
            <arg value="deploy" />
            <arg value="-PortletAppName" />
            <arg value="HW_App" />
            <arg value="-warfilename" />
            <arg value="../applications/demo/target/demo.war" />
            <arg value="-webappDir" />
            <arg value="${pam.deploy.dir}/" />
            <arg value="-PortalName" />
            <arg value="jetspeed" />
        </java>
  </goal>

 <goal name="pam.tsdeploy">
         <java classname="org.apache.jetspeed.tools.pamanager.PortletApplicationManager" fork="yes">
          <classpath>
            <path refid="maven.dependency.classpath"/>
            <pathelement path="${maven.build.dest}"/>
          </classpath>
            <sysproperty key="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.database.url}"/>
            <sysproperty key="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.database.driver}"/>
            <sysproperty key="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.database.user}"/>
            <sysproperty key="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.database.password}"/>
            <arg value="-action" />
            <arg value="deploy" />
            <arg value="-PortletAppName" />
            <arg value="testsuite" />
            <arg value="-warfilename" />
            <arg value="../../jakarta-pluto/testsuite/target/testsuite.war" />
            <arg value="-webappDir" />
            <arg value="${pam.deploy.dir}/" />
            <arg value="-PortalName" />
            <arg value="jetspeed" />
        </java>
  </goal>

  <goal name="pam.undeploy">
         <java classname="org.apache.jetspeed.tools.pamanager.PortletApplicationManager" fork="yes">
          <classpath>
            <path refid="maven.dependency.classpath"/>
            <pathelement path="${maven.build.dest}"/>
          </classpath>
            <sysproperty key="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.database.url}"/>
            <sysproperty key="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.database.driver}"/>
            <sysproperty key="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.database.user}"/>
            <sysproperty key="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.database.password}"/>
            <arg value="-action" />
            <arg value="undeploy" />
            <arg value="-PortletAppName" />
            <arg value="HW_App" />
            <arg value="-webappDir" />
            <arg value="${pam.deploy.dir}/" />
            <arg value="-PortalName" />
            <arg value="jetspeed" />
            <arg value="-ApplicationType" />
            <arg value="webapp" />
        </java>
  </goal>


  <goal name="pam.tsundeploy">
         <java classname="org.apache.jetspeed.tools.pamanager.PortletApplicationManager" fork="yes">
          <classpath>
            <path refid="maven.dependency.classpath"/>
            <pathelement path="${maven.build.dest}"/>
          </classpath>
            <sysproperty key="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.database.url}"/>
            <sysproperty key="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.database.driver}"/>
            <sysproperty key="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.database.user}"/>
            <sysproperty key="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.database.password}"/>
            <arg value="-action" />
            <arg value="undeploy" />
            <arg value="-PortletAppName" />
            <arg value="testsuite" />
            <arg value="-webappDir" />
            <arg value="${pam.deploy.dir}/" />
            <arg value="-PortalName" />
            <arg value="jetspeed" />
            <arg value="-ApplicationType" />
            <arg value="webapp" />
        </java>
  </goal>


  <!-- ================================================================ -->
  <!-- Deploy to Catalina and Expand                                    -->
  <!-- ================================================================ -->
  <goal name="deploy">
     <echo message="Deploying ${pom.id}, ${pom.name}"/>
      <delete dir="${deploy.war.dir}/${webapp.name}"/>
      <!-- <copy  file="./target/jetspeed-2.0-a1-dev.war" tofile="${deploy.war.dir}/${webapp.name}.war"/>-->
      <copy  file="./target/jetspeed.war" tofile="${deploy.war.dir}/${webapp.name}.war"/>
      <unwar src="${deploy.war.dir}/${webapp.name}.war" dest="${deploy.war.dir}/${webapp.name}"/>
      <copy  file="./src/resources/jetspeed.xml" tofile="${deploy.war.dir}/jetspeed.xml"/>
      <attainGoal name="catalina:base-shared" />
      <attainGoal name="catalina:shared" />
  </goal>

  <!-- ================================================================ -->
  <!-- Hot Deploy for mundane everyday development under Catalina       -->
  <!-- ================================================================ -->
  <goal name="hotdeploy">
    <echo message="Hot Deploying ${pom.id}, ${pom.name} ${webapp.dir}"/>
    <copy todir="${deploy.war.dir}/${webapp.name}/WEB-INF/classes">
        <fileset dir="${maven.build.dir}/classes">
        </fileset>
    </copy>
    <copy todir="${deploy.war.dir}/${webapp.name}/">
      <fileset dir="${webapp.dir}">
         <exclude name="WEB-INF/db/**"/>
      </fileset>
    </copy>
  </goal> 
  
  

  
  <!-- ================================================================ -->
  <!-- Does all three deployment steps at once                                                                        -->
  <!-- ================================================================ -->
  <goal name="fullDeploy">
  	 <attainGoal name="deploy" />
  	 <attainGoal name="pam.register" />
  	 <attainGoal name="pam.deploy" />
     <attainGoal name="db.entities" />
  </goal>

  <preGoal name="hotdeploy">
   <attainGoal name= "java:compile"/>
  </preGoal>

  <goal name="deployClasses">
    <attainGoal name="java:compile"/>
    <attainGoal name="java:jar-resources"/>
    <copy todir="${deploy.war.dir}/${webapp.name}/WEB-INF/classes">
      <fileset dir="${basedir}/target/classes" />
    </copy>
     <copy todir="${deploy.war.dir}/${webapp.name}">
      <fileset dir="${basedir}/src/webapp" />
    </copy>
  </goal>

  <goal name="debugWebapp">
    <copy todir="${debug.webapp.dir}/jetspeed">
      <fileset dir="${basedir}/src/webapp" />
    </copy>

     <java classname="org.apache.jetspeed.tools.pamanager.PortletApplicationManager" fork="yes">
       <classpath>

         <path refid="maven.dependency.classpath"/>
         <pathelement path="${maven.build.dest}"/>
        </classpath>
        <sysproperty key="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.database.url}"/>
        <sysproperty key="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.database.driver}"/>
        <sysproperty key="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.database.user}"/>
        <sysproperty key="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.database.password}"/>
         <arg value="-action" />
         <arg value="deploy" />
         <arg value="-PortletAppName" />
         <arg value="HW_App" />
         <arg value="-warfilename" />
         <arg value="../applications/demo/target/demo.war" />
         <arg value="-webappDir" />
         <arg value="${debug.webapp.dir}/" />
         <arg value="-PortalName" />
         <arg value="jetspeed" />
         <arg value="-DbAlias" />
         <arg value="${debug.webapp.dir}/jetspeed/WEB-INF/db/hsql/Registry" />

      </java>

  </goal>

  <goal name="catalina:base-shared"
        description="Copy all base jars necessary for common container">
    <echo>Copying from ${maven.repo.local} to ${catalina.shared.lib}...</echo>
    <!--<copy file="${maven.repo.local}/pluto-container/jars/pluto-1.0.jar" todir="${catalina.shared.lib}"/>-->
    <copy file="${maven.repo.local}/pluto/jars/pluto-1.0-SNAPSHOT.jar" todir="${catalina.shared.lib}"/>
    <copy file="${maven.repo.local}/commons-lang/jars/commons-lang-2.0.jar" todir="${catalina.shared.lib}"/>
    <copy file="${maven.repo.local}/commons-logging/jars/commons-logging-1.0.3.jar" todir="${catalina.shared.lib}"/>
    <copy file="${maven.repo.local}/commons-configuration/jars/commons-configuration-1.0-dev.jar" todir="${catalina.shared.lib}"/>
    <copy file="${maven.repo.local}/log4j/jars/log4j-1.2.6.jar" todir="${catalina.shared.lib}"/>
  </goal>

  <goal name="catalina:shared"
        description="Copy all jars necessary for common container">
    <copy file="../commons/target/jetspeed-commons-2.0-a1-dev.jar" todir="${catalina.shared.lib}"/>
    <copy file="../portlet-api/target/portlet-api-1.0.jar" todir="${catalina.shared.lib}"/>
  </goal>
  
  <!-- ================================================================ -->
  <!-- Copy OJB mapping for registry into the portal directory-->
  <!-- ================================================================ -->
  <goal name="ojb.registry">
    <!-- <copy  file="./../services/registry/src/webapp/WEB-INF/conf/ojb/repository_registry.xml" tofile="./src/webapp/WEB-INF/conf/ojb/repository_registry.xml"/> -->
    <!--<copy  file="./../services/security/src/webapp/WEB-INF/conf/ojb/repository_security.xml" tofile="./src/webapp/WEB-INF/conf/ojb/repository_security.xml"/>-->
  </goal>
  

 <goal name="pam.rssdeploy">
         <java classname="org.apache.jetspeed.tools.pamanager.PortletApplicationManager" fork="yes">
          <classpath>
            <path refid="maven.dependency.classpath"/>
            <pathelement path="${maven.build.dest}"/>
          </classpath>
            <sysproperty key="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.database.url}"/>
            <sysproperty key="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.database.driver}"/>
            <sysproperty key="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.database.user}"/>
            <sysproperty key="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.database.password}"/>
            <arg value="-action" />
            <arg value="deploy" />
            <arg value="-PortletAppName" />
            <arg value="rss" />
            <arg value="-warfilename" />
            <arg value="../applications/rss.war" />
            <arg value="-webappDir" />
            <arg value="${pam.deploy.dir}/" />
            <arg value="-PortalName" />
            <arg value="jetspeed" />
            <arg value="-ApplicationType" />
            <arg value="webapp" />
        </java>
  </goal>

  <!-- ================================================================ -->
  <!-- EXECUTE a DB SCRIPT                                              -->
  <!-- ================================================================ -->
  <goal name="db.execute">
    <sql driver="${org.apache.jetspeed.database.driver}"
         classpathref="maven.dependency.classpath"
         url="${org.apache.jetspeed.database.url}"
         userid="${org.apache.jetspeed.database.user}"
         password="${org.apache.jetspeed.database.password}"
         src="${database.arg.script}">
    </sql>
  </goal>

  <goal name="db.entities">
      <j:set var="database.arg.script" value="../src/sql/populate-entities-for-default-psml.sql" />
      <attainGoal name="db.execute" />
  </goal>

  <preGoal name="war">
   <attainGoal name= "jar:install"/>
  </preGoal>

</project>
